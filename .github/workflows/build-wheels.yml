# Copyright Â© 2025-2026 Wenze Wei. All Rights Reserved.
#
# This file is part of Zi.
# The Zi project belongs to the Dunimd team.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

################################################################################
# Zi Rust Library and Python Wheel Build Pipeline
################################################################################
#
# Purpose:
# This GitHub Actions workflow builds the Zi Rust library and generates
# distributable Python wheel packages (.whl files) for multiple platforms,
# architectures, and Python versions.
#
# Build Strategy:
# - Native compilation on matching architecture runners (no cross-compilation)
# - Linux ARM64 uses ubuntu-24.04-arm for proper ARM64 native builds
# - macOS x64 uses macos-15-intel for Intel builds
# - maturin as the build tool (Rust/Python integration framework)
#
# Supported Platforms:
# - Linux: x64 and arm64 architectures
# - Windows: x64 architecture
# - macOS: x64 and arm64 (Apple Silicon) architectures
#
# Supported Python Versions: 3.8, 3.9, 3.10, 3.11, 3.12, 3.13, 3.14
#
# Trigger Conditions:
# - Automatic: On push to master branch or release published
# - Manual: Workflow dispatch allows manual execution
################################################################################

name: Build and Publish Zi (Rust/Python)

on:
  push:
    branches:
      - master
      - main
  release:
    types: [published]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  CARGO_NET_TIMEOUT: 60

jobs:
  ################################################################################
  # Phase 1: Build Rust Libraries (Parallel)
  ################################################################################

  build-rust-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libsasl2-dev libssl-dev
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: ${{ runner.os }}-cargo-zi-${{ hashFiles('**/Cargo.lock') }}
      - run: cargo build --release --features full
      - uses: actions/upload-artifact@v4
        with:
          name: rust-linux-x64
          path: target/release/libZi.*

  build-rust-linux-arm64:
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu
      - run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libsasl2-dev libssl-dev
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: ${{ runner.os }}-arm64-cargo-zi-${{ hashFiles('**/Cargo.lock') }}
      - run: cargo build --release --features full
      - uses: actions/upload-artifact@v4
        with:
          name: rust-linux-arm64
          path: target/release/libZi.*

  build-rust-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: ${{ runner.os }}-cargo-zi-${{ hashFiles('**/Cargo.lock') }}
      - run: cargo build --release --features full
      - uses: actions/upload-artifact@v4
        with:
          name: rust-windows-x64
          path: target/release/Zi.lib

  build-rust-macos:
    runs-on: macos-15-intel
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-apple-darwin
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: ${{ runner.os }}-cargo-zi-${{ hashFiles('**/Cargo.lock') }}
      - run: |
          mkdir -p .cargo
          echo '[target.x86_64-apple-darwin]' > .cargo/config.toml
          echo 'rustflags = ["-C", "link-arg=-undefined", "-C", "link-arg=dynamic_lookup"]' >> .cargo/config.toml
      - run: cargo build --release --target x86_64-apple-darwin --features full
      - uses: actions/upload-artifact@v4
        with:
          name: rust-macos-x64
          path: target/x86_64-apple-darwin/release/libZi.*

  build-rust-macos-arm64:
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: ${{ runner.os }}-arm64-cargo-zi-${{ hashFiles('**/Cargo.lock') }}
      - run: |
          mkdir -p .cargo
          echo '[target.aarch64-apple-darwin]' > .cargo/config.toml
          echo 'rustflags = ["-C", "link-arg=-undefined", "-C", "link-arg=dynamic_lookup"]' >> .cargo/config.toml
      - run: cargo build --release --target aarch64-apple-darwin --features full
      - uses: actions/upload-artifact@v4
        with:
          name: rust-macos-arm64
          path: target/aarch64-apple-darwin/release/libZi.*

  ################################################################################
  # Phase 2: Build Python Wheels (Matrix)
  ################################################################################

  build-python:
    needs: [build-rust-linux, build-rust-linux-arm64, build-rust-windows, build-rust-macos, build-rust-macos-arm64]
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - python: '3.8'
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: true
          - python: '3.9'
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: true
          - python: '3.10'
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: true
          - python: '3.11'
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: true
          - python: '3.12'
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: true
          - python: '3.13'
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: true
          - python: '3.14'
            runs-on: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: true
          # Linux ARM64
          - python: '3.8'
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: false
          - python: '3.9'
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: false
          - python: '3.10'
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: false
          - python: '3.11'
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: false
          - python: '3.12'
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: false
          - python: '3.13'
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: false
          - python: '3.14'
            runs-on: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            manylinux: manylinux_2_39
            docker: false
          # Windows x64
          - python: '3.8'
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
          - python: '3.9'
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
          - python: '3.10'
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
          - python: '3.11'
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
          - python: '3.12'
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
          - python: '3.13'
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
          - python: '3.14'
            runs-on: windows-latest
            target: x86_64-pc-windows-msvc
          # macOS x64
          - python: '3.8'
            runs-on: macos-15-intel
            target: x86_64-apple-darwin
          - python: '3.9'
            runs-on: macos-15-intel
            target: x86_64-apple-darwin
          - python: '3.10'
            runs-on: macos-15-intel
            target: x86_64-apple-darwin
          - python: '3.11'
            runs-on: macos-15-intel
            target: x86_64-apple-darwin
          - python: '3.12'
            runs-on: macos-15-intel
            target: x86_64-apple-darwin
          - python: '3.13'
            runs-on: macos-15-intel
            target: x86_64-apple-darwin
          - python: '3.14'
            runs-on: macos-15-intel
            target: x86_64-apple-darwin
          # macOS ARM64
          - python: '3.8'
            runs-on: macos-15
            target: aarch64-apple-darwin
          - python: '3.9'
            runs-on: macos-15
            target: aarch64-apple-darwin
          - python: '3.10'
            runs-on: macos-15
            target: aarch64-apple-darwin
          - python: '3.11'
            runs-on: macos-15
            target: aarch64-apple-darwin
          - python: '3.12'
            runs-on: macos-15
            target: aarch64-apple-darwin
          - python: '3.13'
            runs-on: macos-15
            target: aarch64-apple-darwin
          - python: '3.14'
            runs-on: macos-15
            target: aarch64-apple-darwin

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python }}

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: stable

      - name: Configure macOS linker
        if: runner.os == 'macOS'
        run: |
          mkdir -p .cargo
          echo '[target.x86_64-apple-darwin]' > .cargo/config.toml
          echo 'rustflags = ["-C", "link-arg=-undefined", "-C", "link-arg=dynamic_lookup"]' >> .cargo/config.toml
          echo '' >> .cargo/config.toml
          echo '[target.aarch64-apple-darwin]' >> .cargo/config.toml
          echo 'rustflags = ["-C", "link-arg=-undefined", "-C", "link-arg=dynamic_lookup"]' >> .cargo/config.toml

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip,~/Library/Caches/pip,~\AppData\Local\pip\Cache
          key: pip-${{ matrix.python }}-${{ matrix.target }}-${{ hashFiles('**/pyproject.toml', '**/Cargo.toml') }}

      - name: Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: rust-${{ matrix.target }}-${{ hashFiles('**/Cargo.toml') }}

      - name: Install system dependencies (Linux)
        if: runner.os == 'Linux'
        run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libsasl2-dev libssl-dev

      - name: Upgrade pip
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip config set global.index-url https://pypi.tuna.tsinghua.edu.cn/simple

      - name: Install dependencies
        run: pip install maturin auditwheel -i https://pypi.org/simple --quiet

      - name: Build wheel (non-Docker)
        if: matrix.docker != true
        run: maturin build --release --features pyo3 --target ${{ matrix.target }} -o dist

      - name: Build wheel (Docker)
        if: matrix.docker == true
        run: |
          maturin build --release --features pyo3 --target ${{ matrix.target }} -o wheelhouse
          auditwheel repair wheelhouse/*.whl -w dist --plat ${{ matrix.manylinux }}_${{ matrix.target == 'aarch64-unknown-linux-gnu' && 'aarch64' || 'x86_64' }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: python-${{ matrix.target }}-${{ matrix.python }}
          path: dist/

  ################################################################################
  # Phase 3: Tests
  ################################################################################

  run-rust-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libsasl2-dev libssl-dev
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: ${{ runner.os }}-test-${{ hashFiles('**/Cargo.lock') }}
      - run: cargo test --release --features full --no-fail-fast -- --test-threads=4

  run-python-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - uses: dtolnay/rust-toolchain@stable
      - run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libsasl2-dev libssl-dev
      - run: |
          python -m pip install --upgrade pip
          pip install maturin
      - run: maturin build --release --features pyo3 -o dist
      - run: pip install dist/*.whl
      - run: python -c "import zix; print('Zi imported successfully')"
      - run: python tests/python/test_core.py
      - run: python tests/python/test_operators.py

  run-benchmarks:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libsasl2-dev libssl-dev
      - uses: actions/cache@v4
        with:
          path: ~/.cargo/registry,~/.cargo/git,target
          key: ${{ runner.os }}-bench-${{ hashFiles('**/Cargo.lock') }}
      - run: cargo bench --features full -- --save-baseline pr-baseline || true

  ################################################################################
  # Phase 4: Publish
  ################################################################################

  publish-pypi:
    needs: build-python
    if: github.event_name == 'release' && !contains(github.event.release.name, 'Test')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: python-*
          merge-multiple: true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install twine
      - run: twine upload dist/*.whl
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}

  publish-testpypi:
    needs: build-python
    if: github.event_name == 'release' && contains(github.event.release.name, 'Test')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist
          pattern: python-*
          merge-multiple: true
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - run: pip install twine
      - run: twine upload --repository-url https://test.pypi.org/legacy/ dist/*.whl
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TEST_API_TOKEN }}

  publish-crate:
    needs: [build-rust-linux, build-rust-linux-arm64, build-rust-windows, build-rust-macos, build-rust-macos-arm64]
    if: github.event_name == 'release' && !contains(github.event.release.name, 'Test')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: sudo apt-get update && sudo apt-get install -y libcurl4-openssl-dev libsasl2-dev libssl-dev
      - run: cargo publish --token ${{ secrets.CARGO_REGISTRY_TOKEN }}

  sync-to-gitee:
    needs: [build-rust-linux, build-rust-linux-arm64, build-rust-windows, build-rust-macos, build-rust-macos-arm64, build-python]
    if: github.event_name == 'release'
    runs-on: ubuntu-latest
    steps:
      - name: Sync Release to Gitee
        run: |
          GITEE_API="https://gitee.com/api/v5/repos/dunimd/zi/releases"
          jq -n \
            --arg token "${{ secrets.GITEE_TOKEN }}" \
            --arg tag "${{ github.event.release.tag_name }}" \
            --arg name "${{ github.event.release.name }}" \
            --arg body "${{ github.event.release.body }}" \
            '{
              access_token: $token,
              tag_name: $tag,
              name: $name,
              body: $body,
              prerelease: false,
              target_commitish: "master"
            }' > payload.json
          curl -X POST "$GITEE_API" -H "Content-Type: application/json" -d @payload.json
